#!/usr/bin/env python3
import requests
import xml.etree.ElementTree as ET
from datetime import datetime, timedelta
import os
import re
import base64
import hmac
import hashlib
import time
import json
from urllib.parse import urlparse
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

GLM_API_KEY = os.getenv('GLM_API_KEY')

# RSS Sources
RSS_SOURCES = [
    {
        'name': 'Google News (AI)',
        'url': 'https://news.google.com/rss/search?q=AI&hl=ko&gl=KR&ceid=KR:ko',
        'source': 'Google News'
    },
    {
        'name': 'OpenAI News',
        'url': 'https://openai.com/news/rss.xml',
        'source': 'OpenAI'
    },
    {
        'name': 'MIT News AI',
        'url': 'https://news.mit.edu/rss/topic/artificial-intelligence2',
        'source': 'MIT News'
    },
    {
        'name': 'AI News',
        'url': 'https://www.artificialintelligence-news.com/feed/',
        'source': 'AI News'
    }
]

# Default background images for fallback
DEFAULT_IMAGES = [
    'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=1920&q=80',
    'https://images.unsplash.com/photo-1620712943543-bcc4688e7485?w=1920&q=80',
    'https://images.unsplash.com/photo-1555255707-c07966088b7b?w=1920&q=80',
    'https://images.unsplash.com/photo-1676299081847-c3c644878e36?w=1920&q=80',
    'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=1920&q=80'
]

def log_message(message):
    timestamp = (datetime.now() + timedelta(hours=9)).strftime('%Y-%m-%d %H:%M')
    print(f"[{timestamp}] {message}")

def generate_jwt_token(api_key):
    try:
        if '.' not in api_key:
            return api_key
        
        id, secret = api_key.split('.')
        
        header = {'alg': 'HS256', 'sign_type': 'SIGN'}
        payload = {
            'api_key': id,
            'exp': int(time.time()) + 3600,
            'timestamp': int(time.time())
        }
        
        header_b64 = base64.b64encode(json.dumps(header).encode()).decode()
        payload_b64 = base64.b64encode(json.dumps(payload).encode()).decode()
        
        message = f"{header_b64}.{payload_b64}"
        signature = hmac.new(
            secret.encode(),
            message.encode(),
            hashlib.sha256
        ).digest()
        signature_b64 = base64.encodebytes(signature).decode().strip()
        
        return f"{message}.{signature_b64}"
    except:
        return api_key

def is_english_text(text):
    """í…ìŠ¤íŠ¸ê°€ ì˜ì–´ì¸ì§€ ê°ì§€"""
    try:
        # í•œêµ­ì–´ ë¬¸ìê°€ ê±°ì˜ ì—†ìœ¼ë©´ ì˜ì–´ë¡œ ê°„ì£¼
        korean_chars = len(re.findall(r'[ê°€-í£]', text))
        return korean_chars < len(text) * 0.3
    except:
        return False

def fetch_og_image(url):
    """ê¸°ì‚¬ ì›ë¬¸ ë§í¬ì—ì„œ og:image ì¶”ì¶œ"""
    try:
        response = requests.get(url, timeout=10, headers={'User-Agent': 'Mozilla/5.0'})
        
        # og:image íƒœê·¸ ì°¾ê¸°
        og_image = re.search(r'<meta property="og:image" content="([^"]+)"', response.text)
        if og_image:
            return og_image.group(1)
        
        # image íƒœê·¸ë„ í™•ì¸
        image_tag = re.search(r'<meta property="og:image" content="([^"]+)"', response.text)
        if image_tag:
            return image_tag.group(1)
        
        return None
    except Exception as e:
        return None

def summarize_with_glm(title, description="", is_english_title=False):
    """ê³ ë„í™”ëœ ìš”ì•½ í•¨ìˆ˜: ë²ˆì—­ + í‚¤ì›Œë“œ ì¶”ì¶œ + ì´ëª¨ì§€ í™œìš©"""
    try:
        url = "https://api.z.ai/api/coding/paas/v4/chat/completions"
        headers = {
            'Authorization': f'Bearer {GLM_API_KEY}',
            'Content-Type': 'application/json'
        }

        if is_english_title:
            prompt = f"""ì˜ì–´ ì œëª©: {title}
ë‚´ìš©: {description}

ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”:
1. ì œëª©ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì„¸ìš”. (ì˜¨ë¼ì¸ ë‰´ìŠ¤ ìŠ¤íƒ€ì¼)
2. ê¸°ì‚¬ì˜ í•µì‹¬ í‚¤ì›Œë“œ 1ê°œë¥¼ ì¶”ì¶œí•˜ì„¸ìš” (ìµœëŒ€ 5ê¸€ì)
3. ê¸°ì‚¬ ë‚´ìš©ì„ 3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ì„¸ìš” (ê° ë¬¸ì¥ 30ì ì´ë‚´, ì´ëª¨ì§€ í¬í•¨)

ì¶œë ¥ í˜•ì‹:
ë²ˆì—­ëœ ì œëª©: [í•œêµ­ì–´ ì œëª©]
í‚¤ì›Œë“œ: [í‚¤ì›Œë“œ]
ğŸ¤– ìš”ì•½1
ğŸ’¡ ìš”ì•½2
ğŸš€ ìš”ì•½3

ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”."""
        else:
            prompt = f"""ì œëª©: {title}
ë‚´ìš©: {description}

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”:
1. ê¸°ì‚¬ì˜ í•µì‹¬ í‚¤ì›Œë“œ 1ê°œë¥¼ ì¶”ì¶œí•˜ì„¸ìš” (ìµœëŒ€ 5ê¸€ì)
2. ê¸°ì‚¬ ë‚´ìš©ì„ 3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ì„¸ìš” (ê° ë¬¸ì¥ 30ì ì´ë‚´, ì´ëª¨ì§€ í¬í•¨)

ì¶œë ¥ í˜•ì‹:
í‚¤ì›Œë“œ: [í‚¤ì›Œë“œ]
ğŸ¤– ìš”ì•½1
ğŸ’¡ ìš”ì•½2
ğŸš€ ìš”ì•½3

ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”."""

        data = {
            'model': 'glm-4.7',
            'messages': [
                {'role': 'system', 'content': 'ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”. í•œêµ­ IT ì „ë¬¸ê°€ê°€ ë¸Œë¦¬í•‘í•˜ëŠ” ë“¯í•œ ì „ë¬¸ì ì¸ ë¬¸ì²´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.'},
                {'role': 'user', 'content': prompt}
            ],
            'max_tokens': 400,
            'temperature': 0.7,
            'thinking': {'type': 'disabled'}
        }

        response = requests.post(url, headers=headers, json=data, timeout=60)

        if response.status_code == 200:
            result = response.json()
            if 'choices' in result and len(result['choices']) > 0:
                message = result['choices'][0]['message']
                if message.get('content', '').strip():
                    return parse_summary_response(message['content'].strip(), is_english_title)
        elif response.status_code == 429:
            log_message("GLM API: ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¶©ì „ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        else:
            log_message(f"GLM API Error ({response.status_code}): {response.text[:100]}")

        return None
    except Exception as e:
        log_message(f"GLM API error: {e}")
        return None

def parse_summary_response(response, is_english_title):
    """ìš”ì•½ ì‘ë‹µ íŒŒì‹±: ì œëª©, í‚¤ì›Œë“œ, ìš”ì•½ ë¶„ë¦¬"""
    translated_title = ""
    keyword = ""
    summary_lines = []
    
    lines = response.split('\n')
    for line in lines:
        line = line.strip()
        if line.startswith('ë²ˆì—­ëœ ì œëª©:'):
            translated_title = line.replace('ë²ˆì—­ëœ ì œëª©:', '').strip()
        elif line.startswith('í‚¤ì›Œë“œ:'):
            keyword = line.replace('í‚¤ì›Œë“œ:', '').strip()
        elif line and not line.startswith('ìš”ì•½'):
            summary_lines.append(line)
    
    summary = '\n'.join(summary_lines[:3])
    return {
        'translated_title': translated_title if is_english_title else '',
        'keyword': keyword,
        'summary': summary
    }

def load_all_news():
    """ê¸°ì¡´ ë‰´ìŠ¤ ë°ì´í„° ë¡œë“œ"""
    try:
        with open('/root/first/all_news.json', 'r', encoding='utf-8') as f:
            return json.load(f)
    except FileNotFoundError:
        return {'dates': []}
    except json.JSONDecodeError:
        return {'dates': []}

def get_existing_links():
    """ê¸°ì¡´ ë‰´ìŠ¤ ë§í¬ ì¶”ì¶œ"""
    all_news = load_all_news()
    links = set()
    for date_entry in all_news['dates']:
        for news in date_entry['news']:
            links.add(news['link'])
    return links

def fetch_ai_news():
    """ë‹¤ì¤‘ RSS ì†ŒìŠ¤ì—ì„œ ë‰´ìŠ¤ ìˆ˜ì§‘ + og:image ì¶”ì¶œ"""
    all_news_items = []
    existing_links = get_existing_links()
    
    log_message("ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹œì‘...")
    
    for rss_source in RSS_SOURCES:
        try:
            log_message(f"ìˆ˜ì§‘ ì¤‘: {rss_source['name']}")
            response = requests.get(rss_source['url'], timeout=30)
            root = ET.fromstring(response.content)
            
            count = 0
            for item in root.findall('.//item'):
                title_elem = item.find('title')
                link_elem = item.find('link')
                pub_date_elem = item.find('pubDate')
                
                if title_elem is None or link_elem is None:
                    continue
                
                title = title_elem.text
                link = link_elem.text
                
                # ì¤‘ë³µ ì²´í¬
                if link in existing_links:
                    continue
                
                # ë‚ ì§œ íŒŒì‹±
                date_str = datetime.now().strftime('%Y-%m-%d')
                if pub_date_elem is not None and pub_date_elem.text:
                    try:
                        dt = datetime.strptime(pub_date_elem.text, '%a, %d %b %Y %H:%M:%S %Z')
                        date_str = dt.strftime('%Y-%m-%d')
                    except:
                        try:
                            dt = datetime.strptime(pub_date_elem.text[:25], '%a, %d %b %Y %H:%M:%S')
                            date_str = dt.strftime('%Y-%m-%d')
                        except:
                            pass
                
                # ì˜ì–´ ì œëª© ê°ì§€
                is_english_title = is_english_text(title)
                
                # ì´ˆê¸° ìš”ì•½ê°’ (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì¬ì‚¬ìš©)
                summary_result = None
                
                # og:image ì¶”ì¶œ
                og_image = None
                try:
                    og_image = fetch_og_image(link)
                except:
                    pass
                
                news_item = {
                    'title': title,
                    'link': link,
                    'date': date_str,
                    'source': rss_source['source'],
                    'category_keyword': '',
                    'summary': '',
                    'image': og_image,
                    'translated_title': '',
                    'is_english': is_english
                }
                
                all_news_items.append(news_item)
                existing_links.add(link)
                count += 1
            
            log_message(f"  â†’ {count}ê°œ ì‹ ê·œ ë‰´ìŠ¤ ìˆ˜ì§‘")
            
        except Exception as e:
            log_message(f"  â†’ ì˜¤ë¥˜: {e}")
            continue
    
    log_message(f"ì´ {len(all_news_items)}ê°œ ì‹ ê·œ ë‰´ìŠ¤ ìˆ˜ì§‘ ì™„ë£Œ")
    return all_news_items

def save_news_json(news_items):
    """ë‰´ìŠ¤ ë°ì´í„° ì €ì¥ (ë‚ ì§œë³„ ê·¸ë£¹í™”)"""
    all_data = load_all_news()
    
    # ë‚ ì§œë³„ ê·¸ë£¹í™”
    news_by_date = {}
    for item in news_items:
        date = item['date']
        if date not in news_by_date:
            news_by_date[date] = []
        news_by_date[date].append(item)
    
    # ë‚ ì§œë³„ ë°ì´í„° ì—…ë°ì´íŠ¸
    for date, items in news_by_date.items():
        update_time = (datetime.now() + timedelta(hours=9)).strftime('%Y-%m-%d %H:%M:%S')
        
        # ê¸°ì¡´ ë‚ ì§œ ë°ì´í„° ì°¾ê¸°
        found = False
        for i, entry in enumerate(all_data['dates']):
            if entry['date'] == date:
                # ê¸°ì¡´ ë‰´ìŠ¤ì™€ í•©ì¹˜ê¸°
                existing_links = {n['link'] for n in entry['news']}
                new_items = [n for n in items if n['link'] not in existing_links]
                all_data['dates'][i]['news'].extend(new_items)
                all_data['dates'][i]['update_time'] = update_time
                found = True
                break
        
        if not found:
            all_data['dates'].append({
                'date': date,
                'update_time': update_time,
                'news': items
            })
    
    # ìµœì‹ ìˆœ ì •ë ¬
    all_data['dates'].sort(key=lambda x: x['date'], reverse=True)
    
    # ì €ì¥
    with open('/root/first/all_news.json', 'w', encoding='utf-8') as f:
        json.dump(all_data, f, ensure_ascii=False, indent=2)
    
    return all_data

def generate_html(news_items):
    """Instagram Reels ìŠ¤íƒ€ì¼ HTML + ë¬´í•œ ìŠ¤í¬ë¡¤"""
    update_time = (datetime.now() + timedelta(hours=9)).strftime('%Y-%m-%d %H:%M:%S')
    
    # ì „ì²´ ë‰´ìŠ¤ ë°ì´í„° ë¡œë“œ
    all_news_data = load_all_news()
    
    # ë‚ ì§œë³„ ë‰´ìŠ¤ë¥¼ í”Œë« ë°°ì—´ë¡œ ë³€í™˜ (ë¬´í•œ ìŠ¤í¬ë¡¤ìš©)
    all_news_flat = []
    for date_entry in all_news_data['dates']:
        for news in date_entry['news']:
            all_news_flat.append(news)
    
    # ë‚ ì§œ ì˜µì…˜ ìƒì„±
    dates_options = ''.join(
        f'<option value="{item["date"]}" {"selected" if item["date"] == datetime.now().strftime("%Y-%m-%d") else ""}>{item["date"]}</option>' 
        for item in all_news_data['dates'][:10]
    )
    
    # initialNews (ìµœì‹  20ê°œ)
    initial_news = all_news_flat[:20]
    
    all_news_json = json.dumps(all_news_flat, ensure_ascii=False)
    initial_news_json = json.dumps(initial_news, ensure_ascii=False)
    
    html = f'''<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ë‰´ìŠ¤ | ìµœì‹  ì†Œì‹</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;700&display=swap');
        
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }}
        
        html, body {{
            height: 100%;
            width: 100%;
            overflow: hidden;
            background: #000000;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }}
        
        .reels-container {{
            height: 100vh;
            width: 100vw;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }}
        
        .reels-container::-webkit-scrollbar {{
            display: none;
        }}
        
        .reel {{
            height: 100vh;
            width: 100vw;
            scroll-snap-align: start;
            scroll-snap-stop: always;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            transition: transform 0.3s ease;
        }}
        
        .reel::before {{
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, transparent 40%, rgba(0,0,0,0.6) 70%, rgba(0,0,0,0.9) 100%);
            z-index: 1;
        }}
        
        .content-overlay {{
            position: relative;
            z-index: 2;
            padding: 24px;
            padding-bottom: 48px;
            width: 100%;
            max-width: 600px;
            animation: slideUp 0.5s ease-out;
        }}
        
        @keyframes slideUp {{
            from {{
                opacity: 0;
                transform: translateY(30px);
            }}
            to {{
                opacity: 1;
                transform: translateY(0);
            }}
        }}
        
        .reel-title {{
            color: #FFFFFF;
            font-size: 26px;
            font-weight: 700;
            line-height: 1.4;
            margin-bottom: 12px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
            word-wrap: break-word;
        }}
        
        .reel-summary {{
            color: #FFFFFF;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 16px;
            text-shadow: 0 1px 4px rgba(0,0,0,0.5);
            white-space: pre-line;
            opacity: 0.95;
        }}
        
        .reel-meta {{
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }}
        
        .reel-source {{
            background: linear-gradient(135deg, #A855F7 0%, #3B82F6 100%);
            color: #FFFFFF;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }}
        
        .reel-date {{
            color: #9CA3AF;
            font-size: 13px;
            font-weight: 500;
        }}
        
        .reel-keyword {{
            color: #A855F7;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }}
        
        .reel-link {{
            display: inline-flex;
            align-items: center;
            color: #3B82F6;
            font-size: 15px;
            font-weight: 600;
            text-decoration: none;
            gap: 4px;
            transition: all 0.3s ease;
        }}
        
        .reel-link:hover {{
            color: #60A5FA;
            transform: translateX(4px);
        }}
        
        .reel-link::after {{
            content: '>';
            font-size: 18px;
            font-weight: 700;
            transition: transform 0.3s ease;
        }}
        
        .reel-link:hover::after {{
            transform: translateX(2px);
        }}
        
        .progress-bar {{
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255,255,255,0.1);
            z-index: 100;
        }}
        
        .progress-fill {{
            height: 100%;
            background: linear-gradient(90deg, #A855F7 0%, #3B82F6 100%);
            transition: width 0.3s ease;
        }}
        
        .top-ui {{
            position: fixed;
            top: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }}
        
        .top-left-ui {{
            display: flex;
            align-items: center;
            gap: 12px;
        }}
        
        .go-latest-btn {{
            background: rgba(168, 85, 247, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50px;
            padding: 10px 20px;
            color: #FFFFFF;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }}
        
        .go-latest-btn:hover {{
            background: #A855F7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
        }}
        
        .go-latest-btn::before {{
            content: 'â¬†';
            font-size: 16px;
            font-weight: 700;
        }}
        
        .date-selector {{
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 8px 12px;
            color: #FFFFFF;
            font-size: 14px;
        }}
        
        .date-selector select {{
            background: rgba(255,255,255,0.1);
            color: #FFFFFF;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }}
        
        .date-selector select option {{
            background: #000000;
            color: #FFFFFF;
        }}
        
        .update-time {{
            color: #9CA3AF;
            font-size: 12px;
            font-weight: 500;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 8px;
        }}
        
        .nav-hint {{
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            color: #9CA3AF;
            font-size: 12px;
            font-weight: 500;
            opacity: 0.7;
            z-index: 100;
        }}
        
        @media (min-width: 769px) {{
            .reel {{
                max-width: 450px;
                margin: 0 auto;
                border-radius: 16px;
                overflow: hidden;
                height: 95vh;
                margin-top: 2.5vh;
            }}
            .content-overlay {{
                max-width: 400px;
                margin: 0 auto;
            }}
        }}
    </style>
</head>
<body>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="top-ui">
        <div class="top-left-ui">
            <div class="go-latest-btn" onclick="goToLatest()">
                ìµœì‹  ë‰´ìŠ¤
            </div>
            <div class="date-selector">
                <select id="dateSelect" onchange="loadNewsForDate(this.value)">
                    {dates_options}
                </select>
            </div>
        </div>
        <div class="update-time">
            {update_time}
        </div>
    </div>
    
    <div class="reels-container" id="reelsContainer">
    </div>
    
    <div class="nav-hint">
        ìœ„/ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
    </div>
    
    <script>
        const allNewsData = {all_news_json};
        const initialNews = {initial_news_json};
        const container = document.getElementById('reelsContainer');
        const progressFill = document.getElementById('progressFill');
        const defaultImages = {DEFAULT_IMAGES};
        let currentData = initialNews;
        let currentIndex = 0;
        
        function renderReels(newsData, startIndex = 0) {{
            container.innerHTML = '';
            currentIndex = startIndex;
            
            newsData.forEach((item, index) => {{
                const reel = document.createElement('div');
                reel.className = 'reel';
                reel.dataset.index = startIndex + index;
                
                // ì´ë¯¸ì§€ ê²°ì •: og:image ë˜ëŠ” ê¸°ë³¸ ì´ë¯¸ì§€
                const bgImage = item.image && item.image.startsWith('http') 
                    ? item.image 
                    : defaultImages[(startIndex + index) % defaultImages.length];
                reel.style.backgroundImage = `url(${{bgImage}})`;
                
                const keyword = item.category_keyword ? `<div class="reel-keyword">#${{item.category_keyword}}</div>` : '';
                
                // ë²ˆì—­ëœ ì œëª© ì‚¬ìš© (ìˆëŠ” ê²½ìš°)
                const displayTitle = item.translated_title || item.title;
                
                reel.innerHTML = `
                    <div class="content-overlay">
                        <div class="reel-meta">
                            <span class="reel-source">${{item.source || 'Unknown'}}</span>
                            <span class="reel-date">${{item.date}}</span>
                        </div>
                        ${{keyword}}
                        <h2 class="reel-title">${{displayTitle}}</h2>
                        <p class="reel-summary">${{item.summary || 'ì „ì²´ ê¸°ì‚¬ ë‚´ìš©ì„ í™•ì¸í•˜ë ¤ë©´ ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì„¸ìš”.'}}</p>
                        <a class="reel-link" href="${{item.link}}" target="_blank">ìì„¸íˆ ë³´ê¸°</a>
                    </div>
                `;
                
                container.appendChild(reel);
            }});
            
            updateProgress();
        }}
        
        function updateProgress() {{
            const reels = container.querySelectorAll('.reel');
            if (reels.length > 0) {{
                const progress = ((currentIndex + 1) / reels.length) * 100;
                progressFill.style.width = `${{progress}}%`;
            }}
        }}
        
        function loadNewsForDate(date) {{
            // í•´ë‹¹ ë‚ ì§œì˜ ë‰´ìŠ¤ë§Œ í•„í„°ë§
            const filteredNews = allNewsData.filter(item => item.date === date);
            if (filteredNews.length > 0) {{
                currentData = filteredNews;
                renderReels(filteredNews, 0);
            }} else {{
                alert('í•´ë‹¹ ë‚ ì§œì˜ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }}
        }}
        
        function goToLatest() {{
            currentData = allNewsData;
            renderReels(allNewsData, 0);
            container.scrollTop = 0;
        }}
        
        container.addEventListener('scroll', () => {{
            const reelHeight = window.innerHeight;
            currentIndex = Math.round(container.scrollTop / reelHeight);
            updateProgress();
        }}, {{ passive: true }});
        
        // Initialize
        renderReels(initialNews);
        
        // Touch support for swipe
        let touchStartY = 0;
        container.addEventListener('touchstart', (e) => {{
            touchStartY = e.touches[0].clientY;
        }}, {{ passive: true }});
        
        container.addEventListener('touchend', (e) => {{
            const touchEndY = e.changedTouches[0].clientY;
            const diff = touchStartY - touchEndY;
            
            if (Math.abs(diff) > 50) {{
                const reelHeight = window.innerHeight;
                if (diff > 0) {{
                    container.scrollTop += reelHeight;
                }} else {{
                    container.scrollTop -= reelHeight;
                }}
            }}
        }}, {{ passive: true }});
    </script>
</body>
</html>'''
    return html

if __name__ == '__main__':
    try:
        # ë‰´ìŠ¤ ìˆ˜ì§‘
        news_items = fetch_ai_news()
        
        if not news_items:
            log_message("ì‹ ê·œ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.")
            exit(0)
        
        # AI ìš”ì•½ (ì‹ ê·œ ë‰´ìŠ¤ë§Œ, ì²˜ìŒ 50ê°œë¡œ ì œí•œ)
        log_message("AI ìš”ì•½ ë° ë²ˆì—­ ì‹œì‘...")
        summarized_count = 0
        skipped_count = 0
        MAX_SUMMARY = 50
        
        for i, item in enumerate(news_items[:MAX_SUMMARY]):
            if item.get('summary'):
                skipped_count += 1
                continue
            
            title_display = item['translated_title'] if item['translated_title'] else item['title'][:30]
            log_message(f"  ìš”ì•½ ì¤‘ ({i+1}/{min(MAX_SUMMARY, len(news_items))}): {title_display}...")
            
            summary_result = summarize_with_glm(item['title'], '', item.get('is_english', False))
            if summary_result:
                item['summary'] = summary_result.get('summary', '')
                item['category_keyword'] = summary_result.get('keyword', '')
                if item.get('is_english') and summary_result.get('translated_title'):
                    item['translated_title'] = summary_result.get('translated_title')
                    item['title'] = summary_result.get('translated_title')
                summarized_count += 1
            else:
                item['summary'] = "ì „ì²´ ê¸°ì‚¬ ë‚´ìš©ì„ í™•ì¸í•˜ë ¤ë©´ ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì„¸ìš”."
        
        # ë‚˜ë¨¸ì§€ ë‰´ìŠ¤ëŠ” ê¸°ë³¸ ìš”ì•½ ì‚¬ìš©
        for i in range(MAX_SUMMARY, len(news_items)):
            news_items[i]['summary'] = "ì „ì²´ ê¸°ì‚¬ ë‚´ìš©ì„ í™•ì¸í•˜ë ¤ë©´ ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì„¸ìš”."
        
        log_message(f"ìš”ì•½ ì™„ë£Œ: {summarized_count}ê°œ ì‹ ê·œ ìš”ì•½, {skipped_count}ê°œ ê¸°ì¡´ ë°ì´í„° ì¬ì‚¬ìš©")
        
        # JSON ì €ì¥
        all_data = save_news_json(news_items)
        total_news = sum(len(d['news']) for d in all_data['dates'])
        log_message(f"ë°ì´í„° ì €ì¥ ì™„ë£Œ: ì´ {total_news}ê°œ ë‰´ìŠ¤")
        
        # HTML ìƒì„±
        html_content = generate_html(news_items)
        with open('/root/first/ai_news.html', 'w', encoding='utf-8') as f:
            f.write(html_content)
        log_message("HTML ìƒì„± ì™„ë£Œ: /root/first/ai_news.html")
        
        log_message("âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ")
        
    except Exception as e:
        log_message(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
